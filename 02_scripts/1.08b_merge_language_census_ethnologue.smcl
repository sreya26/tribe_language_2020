{smcl}
{txt}{sf}{ul off}{.-}
      name:  {res}plog_792
       {txt}log:  {res}/Users/sreyamajumder/Dropbox/sreya_majumder/tribelanguage_2020 sreya/02_scripts/1.08b_merge_language_census_ethnologue.smcl
  {txt}log type:  {res}smcl
 {txt}opened on:  {res} 6 Sep 2021, 21:07:35
{txt}
{com}. project , uses("../08_temp/census1961_st_mothertongue.dta")
{txt}project version2_tribe_language > do-file uses: {res}"08_temp/census1961_st_mothertongue.dta" filesig(1104297003:25208159){txt}

{com}. project , uses("../08_temp/ethnologue_tree.dta")
{txt}project version2_tribe_language > do-file uses: {res}"08_temp/ethnologue_tree.dta" filesig(3499172153:194755){txt}

{com}. project , original("../01_data/ethnologue_data/unmerged_languages_inprogress_2021_09.xlsx") 
{txt}project version2_tribe_language > do-file uses original: {res}"01_data/ethnologue_data/unmerged_languages_inprogress_2021_09.xlsx" filesig(598395434:59583){txt}

{com}. 
. ********************************************************************************************************************************
. * This do-file merges "census1961mothertongue.dta" and "ethnologue_tree.dta"
. *! version 1.0 created on 12 July 2020 by Hemanshu Kumar; 
. * the first version to be compatible with Robert Picard's -project- command
. * also updated to Ethnologue edition 23
. ********************************************************************************************************************************
. 
. use "../08_temp/census1961_st_mothertongue", clear
{txt}
{com}. 
. keep state mothertongue 
{txt}
{com}. gen language = mothertongue
{txt}
{com}. 
. replace language = lower(language)
{txt}(0 real changes made)

{com}. replace language = subinstr(language,"-"," ",.)
{txt}(382 real changes made)

{com}. replace language = subinstr(language,"/"," ",.)
{txt}(1,299 real changes made)

{com}. replace language = subinstr(language,"*"," ",.)
{txt}(0 real changes made)

{com}. replace language = subinstr(language,","," ",.)
{txt}(0 real changes made)

{com}. 
. replace language = trim(itrim(language))
{txt}(24 real changes made)

{com}. 
. duplicates drop language, force

{p 0 4}{txt}Duplicates in terms of {res} language{p_end}

{txt}(16,884 observations deleted)

{com}. 
. drop if language=="total" 
{txt}(1 observation deleted)

{com}. drop if language=="all scheduled tribes" 
{txt}(0 observations deleted)

{com}. drop if language=="all mother tongues" 
{txt}(1 observation deleted)

{com}. 
. tempfile census_languages
{txt}
{com}. save `census_languages'
{txt}{p 0 4 2}
file {bf}
/var/folders/m0/4lyk4gcd0rs88ghc7sdnwc600000gn/T//S_13929.000008{rm}
saved
as .dta format
{p_end}

{com}. 
. // Merge dataset with the Ethnologue tree
. 
. use "../08_temp/ethnologue_tree", clear
{txt}
{com}. gen language_ethnologue = language
{txt}
{com}. 
. replace language = lower(language)
{txt}(842 real changes made)

{com}. 
. replace language = subinstr(language,"-"," ",.)
{txt}(28 real changes made)

{com}. replace language = subinstr(language,"/"," ",.)
{txt}(0 real changes made)

{com}. replace language = subinstr(language,"*"," ",.)
{txt}(0 real changes made)

{com}. replace language = subinstr(language,","," ",.)
{txt}(214 real changes made)

{com}. 
. replace language = trim(itrim(language))
{txt}(213 real changes made)

{com}. 
. duplicates drop language, force

{p 0 4}{txt}Duplicates in terms of {res} language{p_end}

{txt}(1 observation deleted)

{com}. 
. tempfile ethnologue_tree_standardized
{txt}
{com}. save `ethnologue_tree_standardized', replace
{txt}{p 0 4 2}
(file {bf}
/var/folders/m0/4lyk4gcd0rs88ghc7sdnwc600000gn/T//S_13929.000009{rm}
not found)
{p_end}
{p 0 4 2}
file {bf}
/var/folders/m0/4lyk4gcd0rs88ghc7sdnwc600000gn/T//S_13929.000009{rm}
saved
as .dta format
{p_end}

{com}. 
. merge 1:1 language using `census_languages'
{res}{txt}{p 0 7 2}
(variable
{bf:language} was {bf:str26}, now {bf:str36} to accommodate using data's values)
{p_end}

{col 5}Result{col 33}Number of obs
{col 5}{hline 41}
{col 5}Not matched{col 30}{res}           1,151
{txt}{col 9}from master{col 30}{res}             735{txt}  (_merge==1)
{col 9}from using{col 30}{res}             416{txt}  (_merge==2)

{col 5}Matched{col 30}{res}             106{txt}  (_merge==3)
{col 5}{hline 41}

{com}. 
. keep language iso state language_ethnologue mothertongue _merge
{txt}
{com}. 
. 
. preserve
{txt}
{com}.         keep if _merge == 3
{txt}(1,151 observations deleted)

{com}.         drop _merge
{txt}
{com}.         drop state mothertongue
{txt}
{com}.         clonevar census_language = language
{txt}
{com}.         tempfile auto_merged
{txt}
{com}.         save `auto_merged'
{txt}{p 0 4 2}
file {bf}
/var/folders/m0/4lyk4gcd0rs88ghc7sdnwc600000gn/T//S_13929.00000b{rm}
saved
as .dta format
{p_end}

{com}. restore
{txt}
{com}. */
. 
. * we now create auto_merged_languages.xlsx and unmerged_languages.xlsx
. * these are to be used to manually match those ethnologue and census languages that we were not not able to automatically do in the merge above
. * the manually edited version of unmerged_languages.xlsx should be renamed to unmerged_languages_inprogress.xlsx (to prevent being overwritten by the code here)
. 
. export excel language state language_ethnologue mothertongue using "../08_temp/auto_merged_languages.xlsx" if _merge == 3, replace firstrow(variables)
{res}{txt}file {bf:../08_temp/auto_merged_languages.xlsx} saved

{com}. export excel language language_ethnologue using "../08_temp/unmerged_languages.xlsx" if _merge == 1, sheet("Ethnologue") sheetreplace
{res}{txt}file {bf:../08_temp/unmerged_languages.xlsx} saved

{com}. export excel language state mothertongue using "../08_temp/unmerged_languages.xlsx" if _merge == 2, sheet("Census") sheetreplace
{res}{txt}file {bf:../08_temp/unmerged_languages.xlsx} saved

{com}. 
. ********************************************************************************************************************************
. * now we take the manually merged languages and automatically merged languages to form a consolidated list
. ********************************************************************************************************************************
. 
. import excel using "../01_data/ethnologue_data/unmerged_languages_inprogress_2021_09.xlsx", sheet("Census") firstrow clear
{res}{text}(9 vars, 420 obs)

{com}. keep if ethnologue_match~=""
{txt}(107 observations deleted)

{com}. keep language ethnologue_match iso
{txt}
{com}. 
. rename language census_language
{res}{txt}
{com}. rename ethnologue_match language
{res}{txt}
{com}. 
. merge m:1 iso using `ethnologue_tree_standardized', keepusing(language_ethnologue) assert(2 3)
{res}
{txt}{col 5}Result{col 33}Number of obs
{col 5}{hline 41}
{col 5}Not matched{col 30}{res}             655
{txt}{col 9}from master{col 30}{res}               0{txt}  (_merge==1)
{col 9}from using{col 30}{res}             655{txt}  (_merge==2)

{col 5}Matched{col 30}{res}             313{txt}  (_merge==3)
{col 5}{hline 41}

{com}. 
. keep if _merge == 3
{txt}(655 observations deleted)

{com}. drop _merge
{txt}
{com}. 
. append using `auto_merged'
{txt}{p 0 7 2}
(variable
{bf:language} was {bf:str20}, now {bf:str36} to accommodate using data's values)
{p_end}

{com}. 
. rename language match_language
{res}{txt}
{com}. rename census_language language
{res}{txt}
{com}. 
. duplicates drop language language_ethnologue, force

{p 0 4}{txt}Duplicates in terms of {res} language language_ethnologue{p_end}

{txt}(1 observation deleted)

{com}. 
. save "../08_temp/matched_language_list", replace
{txt}{p 0 4 2}
file {bf}
../08_temp/matched_language_list.dta{rm}
saved
{p_end}

{com}. 
. project , creates("../08_temp/auto_merged_languages.xlsx")
{txt}project version2_tribe_language > do-file creates: {res}"08_temp/auto_merged_languages.xlsx" filesig(401607139:5853){txt}

{com}. project , creates("../08_temp/unmerged_languages.xlsx")
{txt}project version2_tribe_language > do-file creates: {res}"08_temp/unmerged_languages.xlsx" filesig(2851524206:48967){txt}

{com}. project , creates("../08_temp/matched_language_list.dta")
{txt}project version2_tribe_language > do-file creates: {res}"08_temp/matched_language_list.dta" filesig(2953818795:44079){txt}

{com}. 
. ********************************************************************************************************************************************************
. * the code below is for use during the manual merging process, and should generally be kept commented out
. * unless the manual merge is being re-done, fixed, etc.
. * this code is dated 2017, and has not been tested with the -project- changes and ethnologue edition update made in 2020
. 
. * district-specific language and tribe matching
. 
. /*
> use "../03_processed/census1961mothertongue", clear
> 
> keep state district mothertongue
> gen language = mothertongue
> 
> replace language = lower(language)
> replace language = subinstr(language,"-"," ",.)
> replace language = subinstr(language,"/"," ",.)
> replace language = subinstr(language,"*"," ",.)
> replace language = subinstr(language,","," ",.)
> replace language = trim(itrim(language))
> 
> drop if language=="total" 
> drop if language=="all scheduled tribes" 
> drop if language=="all mother tongues" 
> 
> duplicates drop state district language, force
> 
> sort language state district
> order language state district
> 
> save "../03_processed/census_languages_with_districts", replace
> 
> ********************************************************************************************************
> 
> * another version: keeping total pop figures
> 
> use "../03_processed/census1961mothertongue", clear
> 
> egen totalp = rowtotal(total_speakers*)
> 
> keep mothertongue totalp
> 
> gen language = mothertongue
> 
> replace language = lower(language)
> replace language = subinstr(language,"-"," ",.)
> replace language = subinstr(language,"/"," ",.)
> replace language = subinstr(language,"*"," ",.)
> replace language = subinstr(language,","," ",.)
> replace language = trim(itrim(language))
> 
> drop if language=="total" 
> drop if language=="all scheduled tribes" 
> drop if language=="all mother tongues" 
> 
> collapse (sum) totalp, by(language)
> 
> gsort -totalp
> 
> tempfile pops
> save `pops'
> 
> use "../03_processed/ethnologue_tree", clear
> gen language_ethnologue = language
> 
> replace language = lower(language)
> 
> replace language = subinstr(language,"-"," ",.)
> replace language = subinstr(language,"/"," ",.)
> replace language = subinstr(language,"*"," ",.)
> replace language = subinstr(language,","," ",.)
> 
> replace language = trim(itrim(language))
> 
> duplicates drop language, force
> 
> 
> merge 1:1 language using "../03_processed/census_languages"
> 
> keep language state language_ethnologue mothertongue _merge
> 
> keep if _merge == 2
> drop _merge
> 
> merge m:1 language using `pops'
> keep if _merge == 3
> drop _merge
> 
> gsort -totalp
> export excel language totalp using "../03_processed/unmerged_language_pops.xlsx", replace firstrow(variable) 
> 
> */
. 
{txt}end of do-file
      name:  {res}plog_792
       {txt}log:  {res}/Users/sreyamajumder/Dropbox/sreya_majumder/tribelanguage_2020 sreya/02_scripts/1.08b_merge_language_census_ethnologue.smcl
  {txt}log type:  {res}smcl
 {txt}closed on:  {res} 6 Sep 2021, 21:07:36
{txt}{.-}
{smcl}
{txt}{sf}{ul off}